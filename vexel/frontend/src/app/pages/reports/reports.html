<section class="page">
  <div class="page-head">
    <div class="brand-badge">VEXEL</div>
    <h2>Relatórios</h2>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>

  <ng-container *ngIf="summary$ | async as summary; else loading">
    <div class="card grid-2">
      <div class="metric">
        <span class="label">Total</span>
        <strong>{{ summary.total }}</strong>
      </div>
      <div class="metric">
        <span class="label">Ativos</span>
        <strong>{{ summary.ativos }}</strong>
      </div>
      <div class="metric">
        <span class="label">Média Ano</span>
        <strong>{{ summary.mediaAno }}</strong>
      </div>
      <div class="metric">
        <span class="label">Média Km</span>
        <strong>{{ summary.mediaKm }}</strong>
      </div>
      <div class="metric">
        <span class="label">Mais Novo</span>
        <strong>{{ summary.maisNovo ?? '—' }}</strong>
      </div>
      <div class="metric">
        <span class="label">Mais Antigo</span>
        <strong>{{ summary.maisAntigo ?? '—' }}</strong>
      </div>
    </div>

    <div class="card charts" *ngIf="summary.total">
      <div class="chart-row">
        <span class="label">Ativos vs Total</span>
        <div class="bar">
          <div class="fill" [style.width.%]="(summary.ativos / summary.total) * 100"></div>
        </div>
        <span class="muted">{{ summary.ativos }} / {{ summary.total }}</span>
      </div>
      <div class="chart-row">
        <span class="label">Idade média (anos)</span>
        <div class="bar">
          <div class="fill alt" [style.width.%]="Math.min(100, (+summary.mediaAno || 0))"></div>
        </div>
        <span class="muted">{{ summary.mediaAno }}</span>
      </div>
    </div>

    <div class="card filters">
      <h3>Filtrar veículos</h3>
      <div class="grid controls">
        <label>Status
          <select [formControl]="filtersForm.controls.status">
            <option value="">Todos</option>
            <option value="active">Ativo</option>
            <option value="inactive">Inativo</option>
          </select>
        </label>
        <label>Marca
          <input [formControl]="filtersForm.controls.brand" placeholder="Ex: Ford" />
        </label>
      </div>
      <div class="filters-actions">
        <button type="button" (click)="loadVehicles()">Filtrar</button>
        <button type="button" class="ghost" (click)="filtersForm.reset(); loadVehicles()">Limpar</button>
      </div>
    </div>

    <div class="card" *ngIf="loadingVehicles">Carregando veículos...</div>
    <div class="card" *ngIf="vehiclesError">{{ vehiclesError }}</div>
    <div class="card" *ngIf="!loadingVehicles && !vehiclesError">
      <div *ngIf="!vehicles.length" class="muted">Nenhum veículo encontrado.</div>
      <table *ngIf="vehicles.length" class="table">
        <thead>
          <tr>
            <th>Placa</th>
            <th>Modelo</th>
            <th>Marca</th>
            <th>Ano</th>
            <th>Status</th>
            <th>Km</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let v of vehicles">
            <td>{{ v.plate }}</td>
            <td>{{ v.model }}</td>
            <td>{{ v.brand }}</td>
            <td>{{ v.year }}</td>
            <td><span class="status-pill" [class.inactive]="v.status !== 'active'">{{ v.status || '—' }}</span></td>
            <td>{{ v.mileage }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>

  <ng-template #loading>
    <div class="card muted">Carregando relatórios...</div>
  </ng-template>
</section>
