<section class="page">
    <!-- Contêiner principal da página de relatórios -->
    <div class="page-head">
        <!-- Badge simples com o nome do sistema -->
        <div class="brand-badge">VEXEL</div>
        <!-- Título da página -->
        <h2>Relatórios</h2>
    </div>

    <!-- Exibe mensagem de erro geral caso exista -->
    <p class="error" *ngIf="error">{{ error }}</p>

    <!-- Usa o async pipe para consumir o observable summary$ -->
    <!-- Se houver valor em summary$, renderiza o conteúdo;
       caso contrário, mostra o template "loading" -->
    <ng-container *ngIf="summary$ | async as summary; else loading">
        <!-- Card com métricas numéricas principais em grid 2 colunas -->
        <div class="card grid-2">
            <div class="metric">
                <span class="label">Total</span>
                <strong>{{ summary.total }}</strong>
            </div>
            <div class="metric">
                <span class="label">Ativos</span>
                <strong>{{ summary.ativos }}</strong>
            </div>
            <div class="metric">
                <span class="label">Média Ano</span>
                <strong>{{ summary.mediaAno }}</strong>
            </div>
            <div class="metric">
                <span class="label">Média Km</span>
                <strong>{{ summary.mediaKm }}</strong>
            </div>
            <div class="metric">
                <span class="label">Mais Novo</span>
                <!-- Se não existir valor, cai no '—' -->
                <strong>{{ summary.maisNovo ?? '—' }}</strong>
            </div>
            <div class="metric">
                <span class="label">Mais Antigo</span>
                <!-- Mesmo tratamento para o mais antigo -->
                <strong>{{ summary.maisAntigo ?? '—' }}</strong>
            </div>
        </div>

        <!-- Card com “gráficos” de barras simples baseados nas métricas -->
        <div class="card charts" *ngIf="summary.total">
            <!-- Proporção de veículos ativos em relação ao total -->
            <div class="chart-row">
                <span class="label">Ativos vs Total</span>
                <div class="bar">
                    <!-- Largura da barra é calculada como porcentagem -->
                    <div class="fill" [style.width.%]="(summary.ativos / summary.total) * 100"></div>
                </div>
                <span class="muted">{{ summary.ativos }} / {{ summary.total }}</span>
            </div>

            <!-- Representação da idade média em anos -->
            <div class="chart-row">
                <span class="label">Idade média (anos)</span>
                <div class="bar">
                    <!-- Usa Math.min para não estourar 100% na barra -->
                    <div class="fill alt" [style.width.%]="Math.min(100, (+summary.mediaAno || 0))"></div>
                </div>
                <span class="muted">{{ summary.mediaAno }}</span>
            </div>
        </div>

        <!-- Card de filtros da listagem de veículos -->
        <div class="card filters">
            <h3>Filtrar veículos</h3>
            <!-- Linha com os campos de filtro, ligados ao filtersForm do TS -->
            <div class="grid controls">
                <!-- Filtro por status usando formControl "status" -->
                <label>Status
          <select [formControl]="filtersForm.controls.status">
            <option value="">Todos</option>
            <option value="active">Ativo</option>
            <option value="inactive">Inativo</option>
          </select>
        </label>
                <!-- Filtro por marca usando formControl "brand" -->
                <label>Marca
          <input [formControl]="filtersForm.controls.brand" placeholder="Ex: Ford" />
        </label>
            </div>
            <!-- Botões para aplicar e limpar filtros -->
            <div class="filters-actions">
                <!-- Chama loadVehicles com os filtros atuais -->
                <button type="button" (click)="loadVehicles()">Filtrar</button>
                <!-- Reseta o formulário e recarrega a listagem -->
                <button type="button" class="ghost" (click)="filtersForm.reset(); loadVehicles()">
          Limpar
        </button>
            </div>
        </div>

        <!-- Estado de carregamento da listagem de veículos -->
        <div class="card" *ngIf="loadingVehicles">Carregando veículos...</div>

        <!-- Exibe erro específico da listagem de veículos -->
        <div class="card" *ngIf="vehiclesError">{{ vehiclesError }}</div>

        <!-- Card principal com a tabela de veículos -->
        <!-- Só aparece se não estiver carregando e não houver erro -->
        <div class="card" *ngIf="!loadingVehicles && !vehiclesError">
            <!-- Mensagem quando não há veículos retornados -->
            <div *ngIf="!vehicles.length" class="muted">Nenhum veículo encontrado.</div>

            <!-- Tabela mostrada apenas se existir ao menos 1 veículo -->
            <table *ngIf="vehicles.length" class="table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Modelo</th>
                        <th>Marca</th>
                        <th>Ano</th>
                        <th>Status</th>
                        <th>Km</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Percorre o array de veículos e monta uma linha para cada um -->
                    <tr *ngFor="let v of vehicles">
                        <td>{{ v.plate }}</td>
                        <td>{{ v.model }}</td>
                        <td>{{ v.brand }}</td>
                        <td>{{ v.year }}</td>
                        <!-- Status com pill, usando classe .inactive quando não for 'active' -->
                        <td>
                            <span class="status-pill" [class.inactive]="v.status !== 'active'">
                {{ v.status || '—' }}
              </span>
                        </td>
                        <td>{{ v.mileage }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-container>

    <!-- Template de carregamento usado enquanto summary$ não emite valor -->
    <ng-template #loading>
        <div class="card muted">Carregando relatórios...</div>
    </ng-template>
</section>